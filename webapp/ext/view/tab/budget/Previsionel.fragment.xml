<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:table="sap.ui.table"
    xmlns:rm="sap.ui.table.rowmodes"
>
    <table:TreeTable
        id="PrevisionnelTreeTable"
        width="100%"
        rowsUpdated="onRowsUpdatedBudgetPXTab"
        rows="{
            path: 'utilities>/previsionelHierarchyWithTotals',
            parameters: {
                arrayNames: ['children'],
                numberOfExpandedLevels: 3
            }
        }"
        selectionMode="None"
        ariaLabelledBy="title"
        enableColumnReordering="false"
        enableColumnFreeze="true"
        fixedColumnCount="99"
    >
        <table:extension>
            <MessageStrip
                text="{= ${utilities>/DataMode} === 'M'
            ? 'Mode manuel : les valeurs affichées ont été saisies manuellement.'
            : 'Mode automatique : les valeurs sont calculées automatiquement.'}"
                type="{= ${utilities>/DataMode} === 'M' ? 'Information' : 'Warning'}"
                showIcon="true"
                showCloseButton="false"
            />
        </table:extension>

        <table:rowMode>
            <rm:Auto minRowCount="{localModel>/tableSettings/minRowCount}" />
        </table:rowMode>

        <table:columns>
            <!-- === Colonne Hiérarchique (comme PxAutre) === -->
            <table:Column width="17rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Hierarchy/Mission" />
                </table:multiLabels>
                <table:template>
                    <Text
                        text="{= ${utilities>isTotalRow} ? ${utilities>name} : 
                                 ${utilities>isNode} ? ${utilities>name} : 
                                 ${utilities>MissionId}}"
                    />
                </table:template>
            </table:Column>

            <!-- === Base columns === -->
            <!--table:Column width="10rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Numéro affaire" />
                </table:multiLabels>
                <table:template>
                    <Text
                        text="{utilities>Affaire}"
                        visible="{= !${utilities>isTotalRow}}"
                    />
                </table:template>
            </table:Column -->

            <table:Column width="12rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Libellé affaire" />
                </table:multiLabels>
                <table:template>
                    <Text
                        text="{utilities>Description}"
                        visible="{= !${utilities>isTotalRow}}"
                    />
                </table:template>
            </table:Column>

            <table:Column width="9rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Facturation / Dépenses" />
                </table:multiLabels>
                <table:template>
                    <!--Text
                        text="{utilities>FacturationDepense}"
                        visible="{= !${utilities>isTotalRow}}"
                    /-->
                    <ObjectStatus
                        text="{utilities>FacturationDepense}"
                        state="{= ${utilities>FacturationDepense} === 'Facturation' ? 'Success' : 'Warning'}"
                        icon="{= ${utilities>FacturationDepense}
                            ? (${utilities>FacturationDepense} === 'Facturation'
                                ? 'sap-icon://money-bills'
                                : 'sap-icon://expense-report')
                            : '' }"
                        visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                    />
                </table:template>
            </table:Column>

            <table:Column width="8rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Reste à facturer" />
                </table:multiLabels>
                <table:template>
                    <Text
                        text="{utilities>ResteAFacturer}"
                        visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                    />
                </table:template>
            </table:Column>

            <table:Column width="8rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Reste à dépenser" />
                </table:multiLabels>
                <table:template>
                    <Text
                        text="{utilities>ResteADepenser}"
                        visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                    />
                </table:template>
            </table:Column>

            <!-- === Année N (2025) === -->
            <table:Column
                width="6rem"
                headerSpan="12,1"
                hAlign="Center"
            >
                <table:multiLabels>
                    <Label text="ANNÉE EN COURS" />
                    <Label text="{= 'Janv ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>JanvN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>JanvN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableJanvN} }"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Févr ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>FevrN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>FevrN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableFevrN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Mars ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>MarsN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>MarsN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableMarsN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Avr ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>AvrN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>AvrN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableAvrN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Mai ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>MaiN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>MaiN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableMaiN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Juin ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>JuinN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>JuinN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableJuinN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Juil ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>JuilN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>JuilN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableJuilN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <!-- === Editable fields (Août → Déc N) === -->
            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Août ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>AoutN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>AoutN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableAoutN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Sept ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>SeptN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>SeptN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableSeptN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Oct ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>OctN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>OctN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableOctN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Nov ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>NovN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>NovN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableNovN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Déc ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>DecN}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>DecN}"
                            submit=".onPrevisionelSubmit"
                            type="Number"
                            editable="{= ${ui>/editable} &amp;&amp; ${utilities>isEditableDecN}}"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <!-- === Année N+1 (2026) — all editable === -->
            <!-- === Année N+1 (2026) === -->
            <table:Column
                width="6rem"
                headerSpan="12,1"
                hAlign="Center"
            >
                <table:multiLabels>
                    <Label text="ANNÉE N+1" />
                    <Label text="{= 'Janv ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>JanvN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>JanvN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Févr ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>FevrN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>FevrN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Mars ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>MarsN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>MarsN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Avr ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>AvrN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>AvrN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Mai ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>MaiN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>MaiN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Juin ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>JuinN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>JuinN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Juil ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>JuilN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>JuilN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Août ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>AoutN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>AoutN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Sept ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>SeptN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>SeptN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Oct ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>OctN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>OctN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Nov ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>NovN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>NovN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <table:Column width="6rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Déc ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <HBox>
                        <Text
                            text="{utilities>DecN1}"
                            visible="{= ${utilities>isTotalRow}}"
                            class="{= 'sapMTextStrong' }"
                        />
                        <Input
                            value="{utilities>DecN1}"
                            type="Number"
                            visible="{= !${utilities>isTotalRow} &amp;&amp; (!${utilities>isNode} || ${utilities>isL0})}"
                            editable="{ui>/editable}"
                            submit=".onPrevisionelSubmit"
                        />
                    </HBox>
                </table:template>
            </table:Column>

            <!-- Totaux -->
            <table:Column width="7rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Total ' + ${utilities>/currentYear}}" />
                </table:multiLabels>
                <table:template>
                    <Text text="{utilities>TotalN}" 
                    visible = "{= (!${utilities>isNode} || ${utilities>isL0})}"/>
                </table:template>
            </table:Column>

            <table:Column width="7rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="{= 'Total ' + ${utilities>/nextYear}}" />
                </table:multiLabels>
                <table:template>
                    <Text text="{utilities>TotalN1}" 
                    visible = "{= (!${utilities>isNode} || ${utilities>isL0})}"/>
                </table:template>
            </table:Column>

            <table:Column width="7rem">
                <table:multiLabels>
                    <Label text="" />
                    <Label text="Au-dela" />
                </table:multiLabels>
                <table:template>
                    <Text text="{utilities>Audela}" 
                    visible = "{= (!${utilities>isNode} || ${utilities>isL0})}" />
                </table:template>
            </table:Column>
        </table:columns>
    </table:TreeTable>
</core:FragmentDefinition>
