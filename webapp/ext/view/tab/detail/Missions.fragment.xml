<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:table="sap.ui.table"
    xmlns:layout="sap.ui.layout"
    xmlns:f="sap.ui.layout.form"
    xmlns:rm="sap.ui.table.rowmodes"
>
    <layout:VerticalLayout width="100%">
        <Toolbar>
            <content>
                <ToolbarSpacer />
                <Button
                    icon="sap-icon://refresh"
                    text="Refresh"
                    press=".onRefreshTree"
                    type="Emphasized"
                />
            </content>
        </Toolbar>
        <table:TreeTable
            id="missionsTreeTable"
            rows="{
                path: 'utilities>/missionsHierarchy',
                parameters: {
                    arrayNames: ['children'],
                    numberOfExpandedLevels: 3
                }
            }"
            selectionMode="None"
            ariaLabelledBy="title"
            enableColumnReordering="false"
        >
            <table:rowMode>
                <rm:Auto
                    minRowCount="{localModel>/tableSettings/minRowCount}"
                    rowContentHeight="Auto"
                />
            </table:rowMode>
            <table:columns>
                <!-- Hierarchy Column -->
                <table:Column width="20rem">
                    <Label text="Hiérarchie" />
                    <table:template>
                        <HBox>
                            <Text
                                text="{= ${utilities>isNode} ? ${utilities>name} : ${utilities>MissionId}}"
                            />
                            <!--Text
                                    text="{= ${utilities>name}}"
                                    visible="{= ${utilities>isNode}}"
                                />
                                <Input
                                    value="{= ${utilities>isNode} ? ${utilities>name} : ${utilities>MissionId}}"
                                    editable="{ui>/editable}"
                                    width="15rem"
                                    visible="{= !${utilities>isNode}}"
                                /-->
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- Mission Type Column -->
                <table:Column width="13rem">
                    <Label text="Mission" />

                    <table:template>
                        <HBox>
                            <ComboBox
                                value="{utilities>MissionCode}"
                                items="{
                                        path: 'utilities>/missionTypes',
                                        templateShareable: false
                                    }"
                                showSecondaryValues="true"
                                filterSecondaryValues="false"
                                editable="{ui>/editable}"
                                width="100%"
                                visible="{= !${utilities>isNode}}"
                                required="true"
                                change=".onMissionCodeChange"
                            >
                                <core:Item
                                    key="{utilities>code}"
                                    text="{utilities>description}"
                                />
                            </ComboBox>
                            <Label
                                text=""
                                visible="{= !${utilities>isNode}}"
                                class="sapMLabelRequired"
                            />
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- Description Column -->
                <table:Column width="15rem">
                    <Label text="Description" />
                    <table:template>
                        <TextArea
                            value="{utilities>description}"
                            editable="{ui>/editable}"
                            width="100%"
                            visible="{= !${utilities>isNode}}"
                            rows="1"
                            growing="true"
                            growingMaxLines="10"
                            maxLength="100"
                            wrapping="Soft"
                            placeholder="Entrer description..."
                        />
                    </table:template>
                </table:Column>

                <!-- Regroupement Column -->
                <table:Column width="10rem">
                    <Label text="Regroupement" />
                    <table:template>
                        <HBox>
                            <Input
                                value="{utilities>Regroupement}"
                                editable="{
                                    parts: [
                                        {path: 'ui>/editable'},
                                        {path: 'utilities>isSTI'}
                                    ],
                                    formatter: '.formatSTIEditable'
                                }"
                                width="100%"
                                visible="{= !${utilities>isNode}}"
                                change=".onRegroupementChange"
                                required="true"
                            />
                            <Label
                                text=""
                                visible="{= !${utilities>isNode}}"
                                class="sapMLabelRequired"
                            />
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- Mission Status Column -->
                <table:Column width="8rem">
                    <Label text="Statut" />
                    <table:template>
                        <HBox>
                            <ComboBox
                                selectedKey="{utilities>statutmission}"
                                items="{
                                path: 'utilities>/missionStatus',
                                templateShareable: false
                            }"
                                editable="{
                                    parts: [
                                        {path: 'ui>/editable'},
                                        {path: 'utilities>isSTI'}
                                    ],
                                    formatter: '.formatSTIEditable'
                                }"
                                width="100%"
                                visible="{= !${utilities>isNode}}"
                                required="true"
                            >
                                <core:Item
                                    key="{utilities>code}"
                                    text="{utilities>description}"
                                />
                            </ComboBox>
                            <Label
                                text=""
                                visible="{= !${utilities>isNode}}"
                                class="sapMLabelRequired"
                            />
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- Start Date Column -->
                <table:Column width="10rem">
                    <Label text="Date début" />
                    <table:template>
                        <HBox>
                            <DatePicker
                                value="{path: 'utilities>StartDate', type: 'sap.ui.model.type.Date', formatOptions: { pattern: 'dd.MM.yyyy', UTC: true}}"
                                displayFormat="short"
                                editable="{ui>/editable}"
                                width="100%"
                                visible="{= !${utilities>isNode}}"
                                required="true"
                            />
                            <Label
                                text=""
                                visible="{= !${utilities>isNode}}"
                                class="sapMLabelRequired"
                            />
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- End Date Column -->
                <table:Column width="10rem">
                    <Label text="Date fin" />
                    <table:template>
                        <HBox>
                            <DatePicker
                                value="{path: 'utilities>EndDate', type: 'sap.ui.model.type.Date', formatOptions: { pattern: 'dd.MM.yyyy', UTC: true }}"
                                displayFormat="short"
                                editable="{ui>/editable}"
                                width="100%"
                                visible="{= !${utilities>isNode}}"
                                required="true"
                            />
                            <Label
                                text=""
                                visible="{= !${utilities>isNode}}"
                                class="sapMLabelRequired"
                            />
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- Actions Column (Add/Delete) -->
                <table:Column
                    width="8rem"
                    visible="{ui>/editable}"
                >
                    <Label text="Actions" />
                    <table:template>
                        <HBox>
                            <Button
                                icon="sap-icon://add"
                                tooltip="Add Mission"
                                press="onAddMissionToGroupement"
                                visible="{
                                    parts: [
                                        { path: 'ui>/editable' },
                                        { path: 'utilities>isNode' },
                                        { path: 'utilities>isL0' }
                                    ],
                                    formatter: '.isGroupementAddVisible'
                                }"
                                type="Accept"
                                class="sapUiSmallMarginEnd"
                            />

                            <Button
                                icon="sap-icon://add"
                                tooltip="Add Groupement"
                                press="onAddGroupement"
                                visible="{
                                    parts: [
                                        {path: 'ui>/editable'},
                                        {path: 'utilities>isNode'},
                                        { path: 'utilities>isL0' }
                                    ],
                                    formatter: '.isFGAAddVisible'
                                }"
                                type="Accept"
                                class="sapUiSmallMarginEnd"
                            />
                            <!-- Delete Button (visible for mission items) -->
                            <Button
                                icon="sap-icon://decline"
                                tooltip="Delete Mission"
                                press="onDeleteMission"
                                visible="{
                                parts: [
                                    {path: 'ui>/editable'},
                                    {path: 'utilities>isNode'},
                                    {path: 'utilities>isNew'}
                                        ],
                                        formatter: '.isDeleteVisible'
                                    }"
                                type="Reject"
                            />
                        </HBox>
                    </table:template>
                </table:Column>
            </table:columns>
        </table:TreeTable>

        <!-- Refresh Toolbar -->
        <!--Toolbar
                width="100%"
                design="Transparent"
            >
                <ToolbarSpacer />
                <Button
                    icon="sap-icon://refresh"
                    text="Refresh"
                    press=".onRefreshTree"
                    type="Emphasized"
                    visible="{ui>/editable}"
                />
            </Toolbar-->
    </layout:VerticalLayout>
</core:FragmentDefinition>
